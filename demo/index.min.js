import { html } from 'lit/static-html.js';
import { css, LitElement } from 'lit';
import { createPopper } from '@popperjs/core/dist/esm/popper';
import AuroLibraryRuntimeUtils from '@aurodesignsystem/auro-library/scripts/utils/runtimeUtils.mjs';
import { AuroDependencyVersioning } from '@aurodesignsystem/auro-library/scripts/runtime/dependencyTagVersioning.mjs';
import { AuroIcon } from '@aurodesignsystem/auro-icon/src/auro-icon.js';

// Copyright (c) 2020 Alaska Airlines. All right reserved. Licensed under the Apache-2.0 license
// See LICENSE in the project root for license information.


class Popover {
  constructor(anchor, popover, placement) {
    this.anchor = anchor;
    this.popover = popover;
    this.options = {
      placement,
      visibleClass: 'data-show'
    };
    this.popover.classList.remove(this.options.visibleClass);
  }

  show() {
    if (this.popper) {
      this.popper.destroy();
    }

    this.popper = createPopper(this.anchor, this.popover, {
      tooltip: this.anchor,
      placement: this.options.placement,
      strategy: 'absolute'
    });
  }

  hide() {
    this.popover.classList.remove(this.options.visibleClass);
  }

  triggerUpdate() {
    this.popper.update();
  }
}

var iconVersion = '5.0.0';

var styleCss = css`.popover{display:inline-block;box-sizing:border-box;border-width:1px;border-style:solid}.label{font-size:var(--ds-text-body-size-xs, 0.75rem);line-height:var(--ds-text-body-size-default, 1rem);white-space:normal}.trigger{position:relative;display:flex;align-items:center;border-width:1px;border-style:solid}.trigger:focus{outline-style:none}@media(hover: hover){.trigger:hover{cursor:pointer}}.triggerContentWrapper{overflow:hidden;flex:1;text-overflow:ellipsis;white-space:nowrap}#showStateIcon{display:flex;height:100%;align-items:center;margin-left:var(--ds-size-100, 0.5rem)}#showStateIcon [auro-icon]{height:var(--ds-size-300, 1.5rem);line-height:var(--ds-size-300, 1.5rem)}#showStateIcon[data-expanded=true] [auro-icon]{transform:rotate(-180deg)}.helpText{margin-top:var(--ds-size-50, 0.25rem);font-size:var(--ds-text-body-size-xs, 0.75rem);line-height:var(--ds-text-body-size-default, 1rem)}:host(:not([data-show])) .popover{display:none}:host([data-show]) .popover{z-index:var(--ds-depth-tooltip, 300)}:host([common]) .trigger,:host([common]) .popover,:host([rounded]) .trigger,:host([rounded]) .popover{border-radius:var(--ds-border-radius, 0.375rem)}:host([common]) .trigger,:host([inset]) .trigger{padding:var(--ds-size-100, 0.5rem) var(--ds-size-150, 0.75rem)}:host([disabled]){pointer-events:none}`;

var colorCss = css`.popover{border-color:var(--ds-auro-dropdown-popover-border-color);background-color:var(--ds-auro-dropdown-popover-container-color);box-shadow:-2px 0 5px 2px var(--ds-auro-dropdown-popover-boxshadow-color),0 2px 5px 1px var(--ds-auro-dropdown-popover-boxshadow-color);color:var(--ds-auro-dropdown-popover-text-color)}.label{color:var(--ds-auro-dropdown-label-text-color)}.trigger{border-color:var(--ds-auro-dropdown-trigger-border-color);background-color:var(--ds-auro-dropdown-trigger-container-color);color:var(--ds-auro-dropdown-trigger-text-color)}.trigger:focus-within,.trigger:active{--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-active-default, #0074c8)}.trigger:focus-within:not(:active){--ds-auro-dropdown-trigger-border-color: var(--ds-color-ui-default-default, #0074c8);box-shadow:inset 0 0 0 1px var(--ds-auro-dropdown-trigger-border-color)}.helpText{color:var(--ds-auro-dropdown-help-text-color)}:host([disabled]){--ds-auro-dropdown-trigger-text-color: var(--ds-color-text-ui-disabled-default, #adadad);--ds-auro-dropdown-label-text-color: var(--ds-color-text-ui-disabled-default, #adadad)}:host([error]){--ds-auro-dropdown-help-text-color: var(--ds-color-text-error-default, #cc1816);--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-error-default, #cc1816)}:host([error]) .trigger{box-shadow:inset 0 0 0 1px var(--ds-auro-dropdown-trigger-border-color)}:host([error]) .trigger:focus-within{--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-ui-focus-default, #2c67b5);box-shadow:none}:host([error]) .trigger:active{--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-ui-focus-default, #2c67b5);box-shadow:inset 0 0 0 1px var(--ds-auro-dropdown-trigger-border-color)}:host([common]),:host([bordered]){--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-secondary-default, #939fad)}:host([common]) .trigger:active,:host([common]) .trigger:focus-within,:host([bordered]) .trigger:active,:host([bordered]) .trigger:focus-within{--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-ui-focus-default, #2c67b5)}:host([disabled][common]),:host([disabled][bordered]){--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-ui-disabled-default, #adadad)}:host([common][error]),:host([bordered][error]){--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-error-default, #cc1816)}:host([common][error]) .trigger,:host([bordered][error]) .trigger{box-shadow:inset 0 0 0 1px var(--ds-auro-dropdown-trigger-border-color)}:host([common][error]) .trigger:focus-within,:host([bordered][error]) .trigger:focus-within{--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-ui-focus-default, #2c67b5);box-shadow:none}:host([common][error]) .trigger:active,:host([bordered][error]) .trigger:active{--ds-auro-dropdown-trigger-border-color: var(--ds-color-border-ui-focus-default, #2c67b5);box-shadow:inset 0 0 0 1px var(--ds-auro-dropdown-trigger-border-color)}`;

var tokensCss = css`:host{--ds-auro-dropdown-help-text-color: var(--ds-color-text-secondary-default, $ds-color-text-secondary-default);--ds-auro-dropdown-label-text-color: var(--ds-color-text-secondary-default, $ds-color-text-secondary-default);--ds-auro-dropdown-popover-border-color: transparent;--ds-auro-dropdown-popover-boxshadow-color: rgba(0 0 0 / .08);--ds-auro-dropdown-popover-container-color: var(--ds-color-container-primary-default, $ds-color-container-primary-default);--ds-auro-dropdown-popover-text-color: var(--ds-color-text-primary-default, $ds-color-text-primary-default);--ds-auro-dropdown-trigger-container-color: var(--ds-color-container-primary-default, $ds-color-container-primary-default);--ds-auro-dropdown-trigger-border-color: transparent;--ds-auro-dropdown-trigger-text-color: var(--ds-color-text-primary-default, $ds-color-text-primary-default)}`;

// Copyright (c) 2020 Alaska Airlines. All right reserved. Licensed under the Apache-2.0 license
// See LICENSE in the project root for license information.


/**
 * @attr { Boolean } bordered - If declared, applies a border around the trigger slot.
 * @attr { Boolean } chevron - If declared, the dropdown displays an display state chevron on the right.
 * @attr { Boolean } disabled - If declared, the dropdown is not interactive.
 * @attr { Boolean } disableEventShow - If declared, the dropdown will only show by calling the API .show() public method.
 * @attr { Boolean } error - If declared in combination with `bordered` property or `helpText` slot content, will apply red color to both.
 * @attr { Boolean } matchWidth - If declared, the popover and trigger will be set to the same width.
 * @attr { Boolean } inset - If declared, will apply padding around trigger slot content.
 * @attr { Boolean } rounded - If declared, will apply border-radius to trigger and default slots.
 * @attr { Boolean } noToggle - If declared, the trigger will only show the the dropdown bib.
 * @attr { Boolean } noHideOnThisFocusLoss - If delclared, the dropdown will not hide when moving focus outside the element.
 * @prop { Boolean } isPopoverVisible - If true, the dropdown bib is displayed.
 * @prop { Boolean } ready - When false the component API should not be called.
 * @slot - Default slot for the popover content.
 * @slot label - Defines the content of the label.
 * @slot helpText - Defines the content of the helpText.
 * @slot trigger - Defines the content of the trigger.
 * @csspart trigger - The trigger content container.
 * @csspart chevron - The collapsed/expanded state icon container.
 * @csspart helpText - The helpText content container.
 * @csspart popover - The bib content container.
 * @event auroDropdown-triggerClick - Notifies that the trigger has been clicked.
 * @event dropdownToggled - (DEPRECATED) Notifies that the visibility of the dropdown bib has changed.
 * @event auroDropdown-ready - Notifies that the component has finished initializing.
 * @event auroDropdown-toggled - Notifies that the visibility of the dropdown bib has changed.
 */
class AuroDropdown extends LitElement {
  constructor() {
    super();

    this.isPopoverVisible = false;
    this.matchWidth = false;
    this.noHideOnThisFocusLoss = false;

    this.privateDefaults();
  }

  /**
   * @private
   * @returns {void} Internal defaults.
   */
  privateDefaults() {
    this.bordered = false;
    this.chevron = false;
    this.disabled = false;
    this.error = false;
    this.inset = false;
    this.placement = 'bottom-start';
    this.rounded = false;
    this.ready = false;
    this.tabIndex = 0;
    this.noToggle = false;

    /**
     * @private
     */
    this.runtimeUtils = new AuroLibraryRuntimeUtils();

    /**
     * Generate unique names for dependency components.
     */
    const versioning = new AuroDependencyVersioning();
    this.iconTag = versioning.generateTag('auro-icon', iconVersion, AuroIcon);
  }

  // function to define props used within the scope of this component
  static get properties() {

    return {
      bordered: {
        type: Boolean,
        reflect: true
      },
      chevron: {
        type: Boolean,
        reflect: true
      },
      disabled: {
        type: Boolean,
        reflect: true
      },
      error: {
        type: Boolean,
        reflect: true
      },
      inset: {
        type: Boolean,
        reflect: true
      },
      matchWidth: {
        type: Boolean,
        reflect: true
      },
      rounded: {
        type: Boolean,
        reflect: true
      },
      noToggle: {
        type: Boolean,
        reflect: true
      },
      noHideOnThisFocusLoss: {
        type: Boolean,
        reflect: true
      },
      isPopoverVisible: { type: Boolean },
      ready:            { type: Boolean },

      /**
       * @private
       */
      dropdownWidth: { type: Number },

      /**
       * @private
       */
      placement:     { type: String },

      /**
       * @private
       */
      tabIndex: { type: Number }
    };
  }

  static get styles() {
    return [
      styleCss,
      colorCss,
      tokensCss
    ];
  }

  /**
   * This will register this element with the browser.
   * @param {string} [name="auro-dropdown"] - The name of element that you want to register to.
   *
   * @example
   * AuroDropdown.register("custom-dropdown") // this will register this element to <custom-dropdown/>
   *
   */
  static register(name = "auro-dropdown") {
    AuroLibraryRuntimeUtils.prototype.registerComponent(name, AuroDropdown);
  }

  connectedCallback() {
    super.connectedCallback();
  }

  disconnectedCallback() {
    super.disconnectedCallback();
  }

  /**
   * @private
   * @returns {void} Makes dropdown content width match the trigger.
   */
  fixWidth() {
    if (this.matchWidth) {
      this.dropdownWidth = this.getBoundingClientRect().width;
    }
  }

  /**
   * @private
   * @returns {void} Automatically defines tabindex where needed for trigger content.
   */
  handleTriggerTabIndex() {
    const triggerSlotContentRoot = this.querySelector('[slot="trigger"');

    // Don't overwrite any tabindex coded directly into the slotted trigger content
    if (!triggerSlotContentRoot.getAttribute('tabindex')) {
      const focusableElementSelectors = [
        'a',
        'button',
        'input:not([type="hidden])',
        'select',
        'textarea',
        '[tabindex]:not([tabindex="-1"])',
        'auro-button',
        'auro-input',
        'auro-hyperlink'
      ];

      focusableElementSelectors.forEach((selector) => {
        // check if the trigger root element itself is focusable
        if (triggerSlotContentRoot.matches(selector)) {
          this.tabIndex = -1;

          return;
        }

        // check if any child content is focusable
        if (triggerSlotContentRoot.querySelector(selector)) {
          this.tabIndex = -1;
        }
      });
    }
  }

  /**
   * @private
   * @returns {void} Determines if dropdown bib should be closed on focus change.
   */
  handleFocusLoss() {
    if (!this.noHideOnThisFocusLoss && !this.hasAttribute('noHideOnThisFocusLoss')) {
      document.activeElement.addEventListener('focusout', () => {
        if (document.activeElement !== document.querySelector('body') && !this.contains(document.activeElement)) {
          this.hide();
        }
      });

      document.querySelector('body').addEventListener('click', (evt) => {
        if (!evt.composedPath().includes(this)) {
          this.hide();
        }
      });
    }
  }

  firstUpdated() {
    // Add the tag name as an attribute if it is different than the component name
    this.runtimeUtils.handleComponentTagRename(this, 'auro-dropdown');

    this.fixWidth();

    this.trigger = this.shadowRoot.querySelector(`#trigger`);
    this.trigger.setAttribute('aria-expanded', this.isPopoverVisible);

    this.triggerChevron = this.shadowRoot.querySelector(`#showStateIcon`);

    this.auroPopover = this.shadowRoot.querySelector('#popover');
    this.popper = new Popover(this.trigger, this.auroPopover, this.placement);

    const handleShow = () => {
      this.toggleShow();
    };

    const toggleDropdown = () => {
      if (this.isPopoverVisible) {
        this.toggleHide();
      } else {
        handleShow();
      }
    };

    const hideByKeyboard = (event) => {
      const key = event.key.toLowerCase();

      if (key === 'escape') {
        this.toggleHide();
      }
    };

    const showByKeyboard = (event) => {
      const key = event.key.toLowerCase();
      if (key === ' ' || key === 'enter') {
        event.preventDefault();
        handleShow();
      }
    };

    const toggleByKeyboard = (event) => {
      const key = event.key.toLowerCase();

      if (key === ' ' || key === 'enter') {
        event.preventDefault();
        toggleDropdown();
      }
    };

    const notifyTriggerClicked = () => {
      const event = new CustomEvent('auroDropdown-triggerClick', {
        composed: true
      });

      this.dispatchEvent(event);
    };

    if (!this.hasAttribute('disableEventShow')) {
      this.trigger.addEventListener('click', () => {
        this.trigger.focus();
      });
      if (this.noToggle) {
        this.trigger.addEventListener('click', handleShow);
        this.trigger.addEventListener('keydown', showByKeyboard);
      } else {
        this.trigger.addEventListener('click', toggleDropdown);
        this.trigger.addEventListener('keydown', toggleByKeyboard);
      }
    } else {
      this.trigger.addEventListener('click', notifyTriggerClicked);
      this.trigger.addEventListener('keydown', (evt) => {
        const key = evt.key.toLowerCase();

        if (key === ' ' || key === 'enter') {
          notifyTriggerClicked();
        }
      });
    }

    this.trigger.addEventListener('keydown', hideByKeyboard);
    this.auroPopover.addEventListener('keydown', hideByKeyboard);

    window.addEventListener('blur', () => {
      this.hide();
    });

    this.notifyReady();
  }

  /**
   * @private
   * @returns {void} Marks the component as ready and sends event.
   */
  notifyReady() {
    this.ready = true;

    this.dispatchEvent(new CustomEvent('auroDropdown-ready', {
      bubbles: true,
      cancelable: false,
      composed: true,
    }));
  }

  /**
   * @private
   * @returns {void} Hides the popover. Fires an update lifecycle.
   */
  toggleHide() {
    this.popper.hide();
    this.isPopoverVisible = false;
    this.removeAttribute('data-show');
    if (this.chevron) {
      this.triggerChevron.removeAttribute('data-expanded');
    }
    this.dispatchEventDropdownToggle();
  }

  /**
   * @private
   * @returns {void} Shows the popover. Fires an update lifecycle.
   */
  toggleShow() {
    if (!this.hasAttribute('disabled')) {
      // Close any dropdown that is already open
      if (document.expandedAuroDropdown) {
        document.expandedAuroDropdown.hide();
      }

      document.expandedAuroDropdown = this;
      this.fixWidth();
      this.popper.show();
      this.isPopoverVisible = true;
      this.setAttribute('data-show', true);
      if (this.chevron) {
        this.triggerChevron.setAttribute('data-expanded', true);
      }

      this.handleFocusLoss();

      this.dispatchEventDropdownToggle();
    }
  }

  /**
   * Hides the dropdown content.
   * @returns {void}
   */
  hide() {
    this.toggleHide();
  }

  /**
   * Shows the dropdown content.
   * @returns {void}
   */
  show() {
    this.toggleShow();
  }

  /**
   * @private
   * @returns {void} Dispatches event with an object showing the state of the dropdown.
   */
  dispatchEventDropdownToggle() {
    const eventDeprecated = new CustomEvent('dropdownToggled', {
      detail: {
        expanded: this.isPopoverVisible,
      },
      composed: true
    });

    this.dispatchEvent(eventDeprecated);

    const event = new CustomEvent('auroDropdown-toggled', {
      detail: {
        expanded: this.isPopoverVisible,
      },
      composed: true
    });

    this.dispatchEvent(event);
  }

  updated(changedProperties) {
    if (changedProperties.has('isPopoverVisible')) {
      this.trigger.setAttribute('aria-expanded', this.isPopoverVisible);
    }
  }

  // function that renders the HTML and CSS into  the scope of the component
  render() {
    return html`
      <div
        id="trigger"
        class="trigger"
        part="trigger"
        role="button"
        aria-labelledby="triggerLabel"
        aria-controls="popover"
        data-trigger-placement="${this.placement}"
        tabindex="${this.tabIndex}">
        <div class="triggerContentWrapper">
          <label class="label" id="triggerLabel">
            <slot name="label"></slot>
          </label>
          <div class="triggerContent" chevron=${this.chevron}>
            <slot
              name="trigger"
              @slotchange="${this.handleTriggerTabIndex()}"></slot>
          </div>
        </div>
        ${this.chevron ? html`
          <div
            id="showStateIcon"
            part="chevron">
            <${this.iconTag}
              category="interface"
              name="chevron-down"
              customColor
              ?disabled=${this.disabled}
              >
            </${this.iconTag}>
          </div>
        ` : undefined}
      </div>
      <div
        class="helpText"
        part="helpText">
        <slot name="helpText"></slot>
      </div>
      <div
        id="popover"
        class="popover"
        part="popover"
        aria-live="polite"
        style=${`min-width: ${this.dropdownWidth}px;`}>
        <slot role="tooltip"></slot>
      </div>
    `;
  }
}

/* eslint-disable jsdoc/require-jsdoc, no-magic-numbers, no-param-reassign */

AuroDropdown.register();
AuroDropdown.register('custom-dropdown');

function initExamples(initCount) {
}

export { initExamples };
